<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de QR Code - Identificação de Cartela</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="leitor.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Leitor de QR Code - Cartelas</h1>
        </header>

        <main>
            <section class="qr-reader-area">
                <div class="video-container">
                    <video id="qr-video" playsinline></video>
                    <div class="scan-line"></div>
                </div>
                <div class="result-container" id="qr-result"></div>
                <div class="cartela-result" id="cartela-result"></div>
                <div class="action-buttons">
                    <button id="scan-again-btn" class="btn btn-primary hidden">Ler Outra Cartela</button>
                </div>
                <div id="status-message" class="status-message hidden"></div>
            </section>
        </main>
    </div>

    <!-- Popup para registrar ganhador -->
    <div id="winnerPopup" class="popup">
        <div class="popup-content">
            <span class="close-popup">&times;</span>
            <h2>Registrar Ganhador</h2>
            <div class="form-group">
                <label for="winnerName">Nome do Ganhador:</label>
                <input type="text" id="winnerName" placeholder="Digite o nome">
            </div>
            <div class="form-group">
                <label>Cartela:</label>
                <div id="cartelaNumber" style="font-weight: bold; padding: 10px; background-color: #f5f5f5; border-radius: 8px;"></div>
            </div>
            <button id="confirmWinner" class="btn-confirmar">Confirmar</button>
        </div>
    </div>

    <script>
        // Mapeamento dos códigos QR para números de cartela
        const cartelas = {
            "B7X2QF": 1,
            "T5L9WA": 2,
            "D2M8ZR": 3,
            "F8N4KY": 4,
            "H3P7VX": 5,
            "Q6J2ML": 6,
            "X4W8RD": 7,
            "L9K5YT": 8,
            "R3V7ZN": 9,
            "U8S4KP": 10,
            "C6N3VB": 11,
            "M2J9QX": 12,
            "Z5F1LY": 13,
            "Y7L3PU": 14,
            "V4N6TD": 15,
            "N8K5WM": 16,
            "A3X9RL": 17,
            "G6B2YU": 18,
            "P5V4NX": 19,
            "S7M1QK": 20,
            "K2F9WL": 21,
            "J8D6XP": 22,
            "W4N3YV": 23,
            "R1K7LM": 24,
            "X6T2QF": 25,
            "L9J4WP": 26,
            "U5V2MK": 27,
            "Q7X3NL": 28,
            "M6W8RK": 29,
            "F2L9TP": 30,
            "B3K7XM": 31,
            "D9V1RQ": 32,
            "Y2N4WL": 33,
            "G5K8MV": 34,
            "N1F3TP": 35,
            "V7W5QL": 36,
            "H4J9XN": 37,
            "K9X2LP": 38,
            "S3N7QV": 39,
            "R6M5WK": 40,
            "P8L2XJ": 41,
            "J3K6YM": 42,
            "X9V7RP": 43,
            "M4N8TL": 44,
            "W1X5QF": 45
        };

        // Elementos da interface
        const qrVideo = document.getElementById('qr-video');
        const qrResult = document.getElementById('qr-result');
        const cartelaResult = document.getElementById('cartela-result');
        const scanAgainBtn = document.getElementById('scan-again-btn');
        const statusMessage = document.getElementById('status-message');
        
        // Elementos do popup
        const winnerPopup = document.getElementById('winnerPopup');
        const closePopup = document.querySelector('.close-popup');
        const confirmWinner = document.getElementById('confirmWinner');
        const winnerNameInput = document.getElementById('winnerName');
        const cartelaNumberDisplay = document.getElementById('cartelaNumber');

        // Variáveis de estado
        let scanning = true;
        let stream = null;
        let currentCartela = null;

        // Iniciar a câmera automaticamente
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                qrVideo.srcObject = stream;
                qrVideo.onloadedmetadata = () => {
                    qrVideo.play().then(() => {
                        requestAnimationFrame(scanQRCode);
                    }).catch(err => {
                        console.error("Erro ao reproduzir vídeo:", err);
                        showStatus("Erro ao acessar a câmera", "error");
                    });
                };
            } catch (err) {
                console.error("Erro ao acessar a câmera:", err);
                showStatus("Não foi possível acessar a câmera. Verifique as permissões.", "error");
            }
        }

        // Função para escanear continuamente o QR Code
        function scanQRCode() {
            if (!scanning) return;

            if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = qrVideo.videoWidth;
                canvas.height = qrVideo.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
                
                try {
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });

                    if (code) {
                        const qrData = code.data.trim();
                        showQRResult(qrData);
                        identifyCartela(qrData);
                        scanning = false;
                    }
                } catch (e) {
                    console.error("Erro ao ler QR Code:", e);
                }
            }

            if (scanning) {
                requestAnimationFrame(scanQRCode);
            }
        }

        // Mostrar resultado do QR Code
        function showQRResult(data) {
            qrResult.textContent = `Código lido: ${data}`;
            qrResult.style.display = 'block';
        }

        // Identificar número da cartela
        function identifyCartela(qrData) {
            const numeroCartela = cartelas[qrData];
            
            if (numeroCartela) {
                currentCartela = numeroCartela;
                cartelaResult.textContent = `Cartela ${numeroCartela} - Parabéns!`;
                cartelaResult.style.display = 'block';
                scanAgainBtn.classList.remove('hidden');
                
                // Mostrar popup para registrar ganhador
                showWinnerPopup(numeroCartela);
                
                // Tocar um som de confirmação (opcional)
                playSuccessSound();
            } else {
                cartelaResult.textContent = "Cartela não identificada";
                cartelaResult.style.display = 'block';
                scanAgainBtn.classList.remove('hidden');
            }
        }

        // Mostrar popup para registrar ganhador
        function showWinnerPopup(cartelaNumber) {
            cartelaNumberDisplay.textContent = `Cartela ${cartelaNumber}`;
            winnerNameInput.value = '';
            winnerPopup.style.display = 'flex';
            winnerNameInput.focus();
        }

        // Fechar popup
        closePopup.addEventListener('click', () => {
            winnerPopup.style.display = 'none';
        });

        // Confirmar ganhador
        confirmWinner.addEventListener('click', async () => {
            const nome = winnerNameInput.value.trim();
            if (nome === '') {
                showStatus("Por favor, digite o nome do ganhador", "error");
                return;
            }
            
            try {
                // Primeiro obtemos os dados atuais
                const response = await fetch('https://api.jsonbin.io/v3/b/68523cc48561e97a5026386a', {
                    headers: {
                        'X-Master-Key': '$2a$10$nGC0x4ZGIrrDOp.2XXhZ1.Fb9T2T.Fk05XB418S.9LZrzsdMvVHuS'
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao buscar dados');
                
                const data = await response.json();
                const participantes = data.record.participantes || [];
                
                // Adiciona o novo participante
                participantes.push(`${nome} (Cartela ${currentCartela})`);
                
                // Atualiza no jsonbin.io
                const updateResponse = await fetch('https://api.jsonbin.io/v3/b/68523cc48561e97a5026386a', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': '$2a$10$nGC0x4ZGIrrDOp.2XXhZ1.Fb9T2T.Fk05XB418S.9LZrzsdMvVHuS'
                    },
                    body: JSON.stringify({
                        ultimoQR: currentCartela,
                        participantes: participantes
                    })
                });
                
                if (!updateResponse.ok) throw new Error('Erro ao atualizar dados');
                
                showStatus("Ganhador registrado com sucesso!", "success");
                winnerPopup.style.display = 'none';
                
            } catch (error) {
                console.error("Erro ao registrar ganhador:", error);
                showStatus("Erro ao registrar ganhador. Tente novamente.", "error");
            }
        });

        // Tocar som de sucesso (opcional)
        function playSuccessSound() {
            const audio = new Audio();
            audio.src = "data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU..."; // Som curto base64
            audio.play().catch(e => console.log("Não foi possível tocar o som:", e));
        }

        // Botão para ler outra cartela
        scanAgainBtn.addEventListener('click', () => {
            qrResult.style.display = 'none';
            cartelaResult.style.display = 'none';
            scanAgainBtn.classList.add('hidden');
            scanning = true;
            scanQRCode();
        });

        // Mostrar mensagens de status
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'success', 'error', 'info');
            statusMessage.classList.add(type);
            
            // Esconder após 3 segundos
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }

        // Fechar ao clicar fora do popup
        window.addEventListener('click', (e) => {
            if (e.target === winnerPopup) {
                winnerPopup.style.display = 'none';
            }
        });

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            startCamera();
        });
    </script>
</body>
</html>